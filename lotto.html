<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8">
<title>‡∏à‡∏±‡∏ö‡∏™‡∏•‡∏≤‡∏Å‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå‡∏à‡πâ‡∏≤ (Admin/User)</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body { font-family: Arial, sans-serif; background:#f7fafc; color:#222; padding:18px; }
.card { background:#fff; border-radius:12px; padding:18px; box-shadow:0 6px 18px rgba(0,0,0,0.06); max-width:600px; margin:20px auto; }
h1 { font-size:22px; margin-bottom:10px; }
input, button { font-size:16px; padding:8px 10px; border-radius:8px; border:1px solid #ccc; }
button { background:#2b6cb0; color:#fff; border:none; cursor:pointer; }
button.ghost { background:#edf2f7; color:#222; border:1px solid #ccc; }
.row { display:flex; gap:8px; align-items:center; margin-top:10px; flex-wrap:wrap; }
.status { margin-top:12px; padding:10px; border-radius:8px; background:#f1f5f9; }
.result { margin-top:12px; font-weight:600; font-size:18px; }
.participants { margin-top:12px; padding:10px; border-radius:8px; background:#e2e8f0; font-size:14px; }
.buddyList { margin-top:10px; padding:10px; border-radius:8px; background:#d0ebff; font-size:14px; display:none; }
</style>
</head>
<body>
<div class="card">
<h1>üéØ ‡∏à‡∏±‡∏ö‡∏™‡∏•‡∏≤‡∏Å‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå‡∏à‡πâ‡∏≤</h1>

<div class="row">
<input type="text" id="nameInput" placeholder="‡∏ä‡∏∑‡πà‡∏≠">
<input type="password" id="passInput" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô">
<button id="loginBtn">‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö</button>
<button id="logoutBtn" class="ghost" style="display:none;">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
<button id="resetBtn" class="ghost" style="display:none;">üóëÔ∏è ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏±‡∏ö‡πÉ‡∏´‡∏°‡πà (Admin)</button>
</div>

<div id="adminPanel" style="display:none; margin-top:10px;">
<h3>‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°</h3>
<div class="row">
<input type="text" id="addParticipantName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°">
<button id="addParticipantBtn">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°</button>
</div>
<div class="row" style="margin-top:10px;">
<button id="showAllBuddiesBtn">üëÄ ‡∏î‡∏π‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏ö‡∏™‡∏•‡∏≤‡∏Å</button>
</div>
<div id="buddyList" class="buddyList"></div>
</div>

<div class="row" id="userActions" style="display:none; margin-top:10px;">
<button id="drawBuddyBtn">üé≤ ‡∏à‡∏±‡∏ö‡∏™‡∏•‡∏≤‡∏Å ‡∏ì ‡∏ö‡∏±‡∏î‡∏ô‡∏µ‡πâ</button>
</div>

<div id="statusBox" class="status" style="display:none;">
<span id="countText"></span>
</div>

<div id="participantsBox" class="participants" style="display:none;">
<h4>‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°:</h4>
<ul id="participantsList"></ul>
</div>

<div id="resultBox" style="display:none;">
<p class="result" id="resultText"></p>
</div>
</div>

<script>
const STORAGE_KEY = "buddy_assignments_userpass";
const ADMIN_NAME = "Katagiri";
const ADMIN_PASS = "Kid51235";

const nameInput = document.getElementById("nameInput");
const passInput = document.getElementById("passInput");
const loginBtn = document.getElementById("loginBtn");
const logoutBtn = document.getElementById("logoutBtn");
const resetBtn = document.getElementById("resetBtn");

const adminPanel = document.getElementById("adminPanel");
const addParticipantName = document.getElementById("addParticipantName");
const addParticipantBtn = document.getElementById("addParticipantBtn");
const showAllBuddiesBtn = document.getElementById("showAllBuddiesBtn");
const buddyList = document.getElementById("buddyList");

const drawBuddyBtn = document.getElementById("drawBuddyBtn");
const userActions = document.getElementById("userActions");

const resultBox = document.getElementById("resultBox");
const resultText = document.getElementById("resultText");
const countText = document.getElementById("countText");
const statusBox = document.getElementById("statusBox");
const participantsBox = document.getElementById("participantsBox");
const participantsList = document.getElementById("participantsList");

let currentUser = null;
let isAdmin = false;

function hashString(str){let h=0;for(let i=0;i<str.length;i++){h=((h<<5)-h)+str.charCodeAt(i);h|=0;}return h;}
function loadAssignments(){try{return JSON.parse(localStorage.getItem(STORAGE_KEY))||{};}catch{return {};} }
function saveAssignments(data){localStorage.setItem(STORAGE_KEY,JSON.stringify(data));}

function updateStatus(){
  const data=loadAssignments();
  const count=Object.keys(data).filter(k=>data[k].buddy).length;
  countText.innerHTML=`‡∏à‡∏±‡∏ö‡∏™‡∏•‡∏≤‡∏Å‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß <b>${count}</b> ‡∏à‡∏≤‡∏Å ${Object.keys(data).length} ‡∏Ñ‡∏ô`;

  participantsList.innerHTML="";
  for(const n of Object.keys(data)){
    const li=document.createElement("li");
    li.textContent=`${n}${data[n].buddy?` - ‡∏à‡∏±‡∏ö‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß‡∏ô‡∏∞`:" - ‡∏¢‡∏±‡∏á‡∏≠‡∏µ‡∏Å"}`;
    participantsList.appendChild(li);
  }
  statusBox.style.display="block";
  participantsBox.style.display="block";
}

function handleLogin(){
  const name = nameInput.value.trim().toLowerCase();
  const pass = passInput.value.trim();
  const data = loadAssignments();

  // Admin
  if(name === ADMIN_NAME.toLowerCase()){
    if(pass !== ADMIN_PASS){alert("‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏ô‡∏∞"); return;}
    alert("‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÇ‡∏î‡∏¢ Admin");
    currentUser = ADMIN_NAME;
    isAdmin = true;
    afterLoginUI();
    updateStatus();
    return;
  }

  // User
  const userKey = Object.keys(data).find(k => k.toLowerCase() === name);
  if(!userKey){alert("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏ô‡∏µ‡πâ"); return;}
  
  currentUser = userKey;
  isAdmin = false;

// ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏´‡∏±‡∏™
if(!data[userKey].hash){ 
  // ‡∏£‡∏´‡∏±‡∏™‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡∏±‡πâ‡∏á ‚Üí ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡∏Å‡πà‡∏≠‡∏ô
  if(pass.length < 4){
    alert("‡∏£‡∏´‡∏±‡∏™‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 4 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£");
    return;
  }
  data[userKey].hash = hashString(pass);
  saveAssignments(data);
  alert("‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏´‡∏±‡∏™‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏∑‡∏°‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏∞");
} else {
  // ‡∏£‡∏´‡∏±‡∏™‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏•‡πâ‡∏ß ‚Üí ‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏î‡∏¥‡∏°
  if(data[userKey].hash !== hashString(pass)){
    alert("‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ú‡∏¥‡∏î‡∏≠‡∏∞");
    return;
  }
}

  alert(`‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° üé≤ ‡∏à‡∏±‡∏ö‡∏™‡∏•‡∏≤‡∏Å`);
  afterLoginUI();
  updateStatus();
}

function afterLoginUI(){
  loginBtn.style.display="none";
  logoutBtn.style.display="inline-block";
  nameInput.disabled=true;
  passInput.disabled=true;

  resetBtn.style.display=isAdmin?"inline-block":"none";
  adminPanel.style.display=isAdmin?"block":"none";
  userActions.style.display=!isAdmin?"flex":"none";
}

function handleLogout(){
  currentUser = null;
  isAdmin = false;
  loginBtn.style.display="inline-block";
  logoutBtn.style.display="none";
  nameInput.disabled=false;
  passInput.disabled=false;
  resetBtn.style.display="none";
  adminPanel.style.display="none";
  userActions.style.display="none";
  buddyList.style.display="none";
  nameInput.value=""; passInput.value="";
  resultBox.style.display="none";
  updateStatus();
}

function handleReset(){
  if(confirm("‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡πÑ‡∏´‡∏°‡∏ß‡πà‡∏≤ ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?")){
    localStorage.removeItem(STORAGE_KEY);
    alert("‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!");
    location.reload();
  }
}

function handleAddParticipant(){
  const pname = addParticipantName.value.trim();
  if(!pname){alert("‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°"); return;}
  const data = loadAssignments();
  if(data[pname]){alert("‡∏ä‡∏∑‡πà‡∏≠‡∏ã‡πâ‡∏≥"); return;}
  data[pname] = {buddy: null, hash: null};
  saveAssignments(data);
  addParticipantName.value="";
  updateStatus();
  alert(`‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°: ${pname} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢`);
}

function handleDrawBuddy(){
  const data = loadAssignments();
  const user = currentUser;
  if(!user){alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô"); return;}
  if(isAdmin){alert("Admin ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏à‡∏±‡∏ö‡∏™‡∏•‡∏≤‡∏Å‡πÄ‡∏≠‡∏á‡πÑ‡∏î‡πâ‡∏ô‡∏∞"); return;}
  if(data[user].buddy){alert(`‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏à‡∏±‡∏ö‡∏™‡∏•‡∏≤‡∏Å‡πÅ‡∏•‡πâ‡∏ß‡∏ô‡∏∞: ${data[user].buddy}`); return;}
  
  const used = new Set(Object.values(data).filter(x=>x.buddy).map(x=>x.buddy));
  const available = Object.keys(data).filter(n=>!used.has(n)&&n!==user);
  if(available.length===0){alert("‡∏à‡∏±‡∏ö‡∏Å‡∏±‡∏ô‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏ô‡∏∞"); return;}
  const buddy = available[Math.floor(Math.random()*available.length)];
  data[user].buddy = buddy;
  saveAssignments(data);
  resultText.textContent = `‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏à‡∏±‡∏ö‡πÑ‡∏î‡πâ‡∏Ñ‡∏∑‡∏≠ ${buddy}`;
  resultBox.style.display="block";
  updateStatus();
}

function handleShowAllBuddies(){
  const data = loadAssignments();
  let html = "<ul>";
  for(const n of Object.keys(data)){
    if(data[n].buddy){
      html += `<li>${n} ‚Üí ${data[n].buddy}</li>`;
    } else {
      html += `<li>${n} ‚Üí ‡∏¢‡∏±‡∏á ‡πÑ‡∏°‡πà‡∏à‡∏±‡∏ö‡∏ô‡∏∞</li>`;
    }
  }
  html += "</ul>";
  buddyList.innerHTML = html;
  buddyList.style.display = "block";
}

loginBtn.addEventListener("click",handleLogin);
logoutBtn.addEventListener("click",handleLogout);
resetBtn.addEventListener("click",handleReset);
addParticipantBtn.addEventListener("click",handleAddParticipant);
drawBuddyBtn.addEventListener("click",handleDrawBuddy);
showAllBuddiesBtn.addEventListener("click",handleShowAllBuddies);

updateStatus();
</script>
</body>
</html>
