<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>üéÅ ‡∏à‡∏±‡∏ö‡∏ö‡∏±‡∏î‡∏î‡∏µ‡πâ‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</title>
<style>
body { font-family:sans-serif; text-align:center; padding:30px; background:#f5f7fb; }
input,button { padding:10px; margin:8px; width:250px; border-radius:8px; }
button { cursor:pointer; background:#007bff; color:#fff; border:none; }
button:hover{background:#0056b3;}
#userPanel,#adminPanel{margin-top:20px;}
#adminPanel{background:#fff;padding:15px;border-radius:10px;width:90%;max-width:500px;margin:0 auto;}
pre{background:#f0f0f0;text-align:left;padding:10px;border-radius:8px;}
</style>
</head>
<body>

<h2>üéÅ ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏ö‡∏ö‡∏±‡∏î‡∏î‡∏µ‡πâ‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</h2>
<input type="text" id="name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì"><br>
<input type="password" id="pass" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô (‚â•4 ‡∏ï‡∏±‡∏ß)"><br>
<button onclick="login()">‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô / ‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏´‡∏±‡∏™</button>

<div id="userPanel" style="display:none;">
  <h3>‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ <span id="userName"></span></h3>
  <button onclick="drawBuddy()">üé≤ ‡∏à‡∏±‡∏ö‡∏ö‡∏±‡∏î‡∏î‡∏µ‡πâ</button>
  <button onclick="logout()">üîì ‡∏•‡πá‡∏≠‡∏Å‡πÄ‡∏≠‡∏≤‡∏ó‡πå</button>
  <p id="result"></p>
  <h4>‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°</h4>
  <pre id="participantsList"></pre>
</div>

<div id="adminPanel" style="display:none;">
  <h3>üõ†Ô∏è ‡πÅ‡∏ú‡∏á‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô</h3>
  <input type="text" id="newName" placeholder="‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°">
  <button onclick="addUser()">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠</button><br>
  <button onclick="viewAll()">‡∏î‡∏π‡∏ú‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
  <button onclick="resetAll()">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ú‡∏•‡∏à‡∏±‡∏ö‡∏ö‡∏±‡∏î‡∏î‡∏µ‡πâ</button>
  <button onclick="clearUsers()">‡∏•‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
  <pre id="adminResult"></pre>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbz2JC9fMKz-4sibtoiJb-tIaIkqSOMED0TN5hZMnVGOf8kjzwQH9VAbX1yV1xb_ELQGJg/exec";
let currentUser=null,isAdmin=false,userHasDrawn=false;

async function postData(action,extra={}) {
  const form = new URLSearchParams({action,...extra});
  const res = await fetch(API_URL,{method:"POST",body:form});
  return res.json();
}

async function login(){
  const name=document.getElementById("name").value.trim();
  const pass=document.getElementById("pass").value.trim();
  if(!name||!pass) return alert("‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡∏£‡∏´‡∏±‡∏™‡∏Å‡πà‡∏≠‡∏ô");
  const res=await postData("login",{name,pass});
  if(res.error) return alert(res.error);
  alert(res.msg);
  currentUser=res.name;
  isAdmin=res.isAdmin;
  document.getElementById("userPanel").style.display=isAdmin?"none":"block";
  document.getElementById("adminPanel").style.display=isAdmin?"block":"none";
  document.getElementById("userName").textContent=currentUser;
  await updateStatus();
}

async function drawBuddy(){
  if(userHasDrawn) return alert("‡∏Ñ‡∏∏‡∏ì‡∏à‡∏±‡∏ö‡∏ö‡∏±‡∏î‡∏î‡∏µ‡πâ‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß");
  const res=await postData("draw",{name:currentUser});
  document.getElementById("result").textContent=res.error||res.msg;
  await updateStatus();
}

async function updateStatus(){
  const res = await postData("view",{name: currentUser});
  if(res.error) return;
  if(isAdmin){
    // Admin ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ + ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
    document.getElementById("adminResult").textContent =
      res.data.map(u=>`${u.Name} ‚Üí ${u.HasDrawn==="TRUE"?"‡∏à‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß":"‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏à‡∏±‡∏ö"}`).join("\n");
  } else {
    // User ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏° + ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (‡πÑ‡∏°‡πà‡∏£‡∏ß‡∏° Admin)
    userHasDrawn = res.me.HasDrawn==="TRUE";
    document.getElementById("participantsList").textContent =
      res.participants.map(u=>`${u.name} ‚Üí ${u.drawn?"‡∏à‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß":"‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏à‡∏±‡∏ö"}`).join("\n");
  }
}

function logout(){
  currentUser=null; isAdmin=false; userHasDrawn=false;
  document.getElementById("userPanel").style.display="none";
  document.getElementById("adminPanel").style.display="none";
  document.getElementById("name").value="";
  document.getElementById("pass").value="";
  document.getElementById("result").textContent="";
  document.getElementById("participantsList").textContent="";
  document.getElementById("adminResult").textContent="";
}

async function addUser(){
  const newName=document.getElementById("newName").value.trim();
  if(!newName) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏´‡∏°‡πà");
  const res=await postData("add_user",{name:currentUser,newName});
  alert(res.msg||res.error);
  await updateStatus();
}

async function viewAll(){
  const res=await postData("view",{name:currentUser});
  if(res.error) return alert(res.error);
  document.getElementById("adminResult").textContent =
    res.data.map(u=>`${u.Name} ‚Üí ${u.HasDrawn==="TRUE"?"‡∏à‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß":"‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏à‡∏±‡∏ö"}`).join("\n");
}

async function resetAll(){
  if(!confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏ú‡∏•‡∏à‡∏±‡∏ö‡∏ö‡∏±‡∏î‡∏î‡∏µ‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏£‡∏¥‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) return;
  const res=await postData("reset",{name:currentUser});
  alert(res.msg||res.error);
  await updateStatus();
}

async function clearUsers(){
  if(!confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏£‡∏¥‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) return;
  const res=await postData("clear_users",{name:currentUser});
  alert(res.msg||res.error);
  await updateStatus();
}
</script>

</body>
</html>
